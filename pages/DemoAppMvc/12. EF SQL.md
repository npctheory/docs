---
title: 12. EF & Sql Repository
layout: page
parent: DemoAppMvc
nav_order: 12
---
[Nuget](#nuget)  
[appsettings.json](#appsettingsjson)  
[AppDbContext.cs](#appdbcontextcs)  
[Program.cs](#programcs)  
[EmployeeManagement/Models/ModelBuilderExtensions.cs](#employeemanagementmodelsmodelbuilderextensionscs)  
[Миграции](#ef-migrations)  
[EmployeeManagement/Models/SQLEmployeeRepository.cs](#employeemanagementmodelssqlemployeerepositorycs)  

### Nuget
Установить Microsoft.EntityFrameworkCore.SqlServer
```bash
dotnet add ./DemoAppMvc package Microsoft.EntityFrameworkCore.SqlServer
dotnet add ./DemoAppMvc package Microsoft.EntityFrameworkCore.Tools
```
### appsettings.json
```json
{
  "ConnectionStrings": {
    "DemoAppMvcConnection" : "server=(localdb)\\MSSQLLocalDB;database=DemoAppMvcDb;Trusted_Connection=true"
  }
}
```
### AppDbContext.cs
```csharp
using Microsoft.EntityFrameworkCore;

public class AppDbContext : DbContext
{
    public AppDbContext(DbContextOptions<AppDbContext> options)
    : base(options)
    {
        
    }

    public DbSet<Employee> Employees {get; set;}

    protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);
            builder.Seed();
        }
}
```

### Program.cs
Получить имя сервера SQL Express - утилита MSSQLLocalDB  
```csharp
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddDbContext<AppDbContext>(options => options.UseSqlServer(
    builder.Configuration.GetConnectionString("EmployeeDbConnection")
));
builder.Services.AddScoped<IEmployeeRepository, SQLEmployeeRepository>();
builder.Services.AddControllersWithViews();
var app = builder.Build();

app.UseStaticFiles();
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");
app.Run();
```

### EmployeeManagement/Models/ModelBuilderExtensions.cs  
```csharp
using Microsoft.EntityFrameworkCore;

public static class ModelBuilderExtensions
{
    public static void Seed(this ModelBuilder builder)
    {
        builder.Entity<Employee>().HasData(
                new Employee{
                    Id = 1,
                    Name = "Alice",
                    Departament = Dept.IT,
                    Email = "alice@example.com"                    
                },
                new Employee{
                    Id = 2,
                    Name = "Bob",
                    Departament = Dept.IT,
                    Email = "bob@example.com"                    
                },
                new Employee{
                    Id = 3,
                    Name = "Charlie",
                    Departament = Dept.IT,
                    Email = "charlie@example.com"                    
                }
            );
    }
}
```
### EF Migrations
```bash
dotnet ef migrations add "init"
dotnet ef database update
```

### EmployeeManagement/Models/SQLEmployeeRepository.cs  
```csharp
public class SQLEmployeeRepository : IEmployeeRepository
{
    private readonly AppDbContext context;

    public SQLEmployeeRepository(AppDbContext context)
    {
        this.context = context;
    }

    public Employee Add(Employee employee)
    {
        context.Employees.Add(employee);
        context.SaveChanges();
        return employee;
    }

    public Employee Delete(int id)
    {
        Employee employee = context.Employees.Find(id);
        if(employee != null)
        {
            context.Employees.Remove(employee);
            context.SaveChanges();
        }
        return employee;
    }

    public IEnumerable<Employee> GetAllEmployees()
    {
        return context.Employees;
    }

    public Employee GetEmployee(int Id)
    {
        return context.Employees.Find(Id);
    }

    public Employee Update(Employee employeeChanges)
    {
        var employee = context.Employees.Attach(employeeChanges);
        employee.State = Microsoft.EntityFrameworkCore.EntityState.Modified;
        context.SaveChanges();
        return employeeChanges;
    }
}
```